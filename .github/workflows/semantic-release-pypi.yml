name: ğŸ“¦ Semantic Release and PyPI Publish

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    steps:
      # æª¢å‡ºæŒ‡å®šåˆ†æ”¯çš„ç¨‹å¼ç¢¼
      # Checkout the repository code (v10.5.0+ automatically handles repository un-shallowing)
      - name: Setup | Checkout Repository on Release Branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref_name }}
          persist-credentials: false # é˜²æ­¢ä½¿ç”¨é è¨­çš„ GITHUB_TOKEN

      # å¼·åˆ¶é‡è¨­æœ¬åœ°åˆ†æ”¯åˆ°è§¸ç™¼å·¥ä½œæµç¨‹çš„ç¢ºåˆ‡æäº¤
      # Force reset local branch to the exact commit that triggered the workflow
      - name: Setup | Force release branch to be at workflow sha
        run: |
          git reset --hard ${{ github.sha }}

      # å®‰è£ uv å·¥å…·
      # Install uv tool
      - name: Setup | Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: false

      # åŸ·è¡Œèªæ„ç‰ˆæœ¬åˆ†æï¼Œè‡ªå‹•æ±ºå®šç‰ˆæœ¬è™Ÿä¸¦å»ºç«‹æ¨™ç±¤
      # Execute semantic version analysis, automatically determine version and create tags
      # v10.5.0+ includes automatic repository un-shallowing and upstream version checking
      - name: Action | Semantic Version Release
        id: release
        uses: python-semantic-release/python-semantic-release@v10.5.0
        with:
          github_token: ${{ secrets.MATHEME_JUSTYN_SEMANTIC }}  # ä½¿ç”¨ä½ çš„æ­£ç¢º token åç¨±

      # åˆ·æ–°æœ¬åœ°ç¨‹å¼ç¢¼ç‹€æ…‹ï¼ˆä¸éœ€è¦é‡æ–° checkoutï¼‰
      # Refresh local code state without re-checkout
      - name: Setup | Refresh local state after version update
        if: steps.release.outputs.released == 'true'
        run: |
          # ç¢ºä¿æœ¬åœ°ç¨‹å¼ç¢¼èˆ‡é ç«¯åŒæ­¥
          # Ensure local code is in sync with remote
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}

      # ä½¿ç”¨ uv å»ºç½® Python å¥—ä»¶ç™¼å¸ƒæª”æ¡ˆ
      # Build Python package distribution files using uv
      - name: Publish | Build package with uv
        if: steps.release.outputs.released == 'true'
        run: |
          # å¾æ¨™ç±¤ä¸­æå–ç‰ˆæœ¬è™Ÿ
          # Extract version from tag
          TAG_VERSION="${{ steps.release.outputs.tag }}"
          VERSION="${TAG_VERSION#v}"  # ç§»é™¤ 'v' å‰ç¶´

          # æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬è™Ÿ
          # Update version in pyproject.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml

          echo "Building with version: $VERSION (from tag: $TAG_VERSION)"
          echo "Updated pyproject.toml: $(grep '^version = ' pyproject.toml)"

          # ä½¿ç”¨ --no-sources ç¢ºä¿å»ºç½®æ™‚ä¸ä½¿ç”¨ tool.uv.sources è¨­å®šï¼Œæå‡ç›¸å®¹æ€§
          # Use --no-sources to ensure build compatibility without tool.uv.sources
          uv build --no-sources

      # ç™¼å¸ƒå¥—ä»¶åˆ° TestPyPI æ¸¬è©¦ç’°å¢ƒï¼ˆåƒ…é™ dev åˆ†æ”¯ï¼‰
      # Publish package to TestPyPI testing environment (dev branch only)
      - name: Publish | Upload package to TestPyPI (dev branch)
        uses: pypa/gh-action-pypi-publish@v1.13.0
        if: steps.release.outputs.released == 'true' && github.ref_name == 'dev'
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TESTPYPI_API_TOKEN }}
          skip-existing: true
          attestations: true

      # ç™¼å¸ƒå¥—ä»¶åˆ°æ­£å¼ PyPI ç’°å¢ƒï¼ˆåƒ…é™ main åˆ†æ”¯ï¼‰
      # Publish package to official PyPI environment (main branch only)
      - name: Publish | Upload package to PyPI (main branch)
        uses: pypa/gh-action-pypi-publish@v1.13.0
        if: steps.release.outputs.released == 'true' && github.ref_name == 'main'
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          attestations: true

      # ä¸Šå‚³æ§‹å»ºæª”æ¡ˆåˆ° GitHub Releases ä½œç‚ºç™¼å¸ƒè³‡ç”¢
      # Upload built files to GitHub Releases as release assets
      - name: Publish | Upload to GitHub Release Assets
        uses: python-semantic-release/publish-action@v10.5.0
        if: steps.release.outputs.released == 'true'
        with:
          github_token: ${{ secrets.WORKFLOW_TOKEN_CLASSICAL }}
          tag: ${{ steps.release.outputs.tag }}