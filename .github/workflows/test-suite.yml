name: 🧪 Test Suite
# 測試套件：運行所有測試確保代碼品質

on:
  push:
    branches: [main, dev]
    paths:
      - "petsard/**"
      - "tests/**"
      - "pyproject.toml"
      - ".github/workflows/test-suite.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "petsard/**"
      - "tests/**"
      - "pyproject.toml"
      - ".github/workflows/test-suite.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: 🧪 Run Tests
    runs-on: ubuntu-latest
    continue-on-error: true # 不強制要求測試通過才能合併

    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v5

      - name: 🐍 Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: 📦 Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: 🔧 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: 🔍 Run Ruff Code Quality Check
        id: ruff-check
        run: |
          # 運行 Ruff 檢查（簡潔版本）
          if ruff check . --output-format=concise > ruff_output.txt 2>&1; then
            echo "ruff_status=success" >> $GITHUB_OUTPUT
            echo "### ✅ 程式碼品質檢查通過 Code Quality Check Passed" >> test_report.md
            echo "" >> test_report.md
          else
            echo "ruff_status=failed" >> $GITHUB_OUTPUT
            
            # 統計錯誤數量
            ERROR_COUNT=$(wc -l < ruff_output.txt)
            
            echo "### ⚠️ 程式碼品質問題 Code Quality Issues" >> test_report.md
            echo "**發現 $ERROR_COUNT 個問題需要修正**" >> test_report.md
            echo "" >> test_report.md
            
            # 顯示前10個錯誤
            echo "**主要問題（前10個）:**" >> test_report.md
            echo "```" >> test_report.md
            head -10 ruff_output.txt >> test_report.md
            echo "```" >> test_report.md
            
            if [ "$ERROR_COUNT" -gt 10 ]; then
              echo "*...還有 $((ERROR_COUNT - 10)) 個問題*" >> test_report.md
            fi
            echo "" >> test_report.md
          fi

      - name: 🧪 Run Unit Tests with Coverage
        id: unit-tests
        run: |
          echo "## 🧪 測試結果 Test Results" >> test_report.md
          echo "" >> test_report.md

          # 運行測試並捕獲結果，使用簡潔格式
          if pytest tests/ --cov=petsard --cov-report=term-missing --cov-report=xml --tb=line --quiet --junit-xml=pytest-results.xml > test_output.txt 2>&1; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            
            # 提取測試統計
            PASSED_COUNT=$(grep -c "PASSED" test_output.txt 2>/dev/null || echo "0")
            TOTAL_COUNT=$(grep -E "^[0-9]+ passed" test_output.txt | grep -o "^[0-9]+" || echo "$PASSED_COUNT")
            
            echo "### ✅ 所有測試通過！All Tests Passed!" >> test_report.md
            echo "" >> test_report.md
            echo "**📊 總計**: $TOTAL_COUNT 個測試全部通過" >> test_report.md
          else
            echo "test_status=failed" >> $GITHUB_OUTPUT
            
            # 提取測試統計（從 pytest 摘要行）
            SUMMARY_LINE=$(grep -E "^[0-9]+ (failed|passed|skipped|error)" test_output.txt | tail -1)
            PASSED_COUNT=$(echo "$SUMMARY_LINE" | grep -o "[0-9]* passed" | grep -o "[0-9]*" || echo "0")
            FAILED_COUNT=$(echo "$SUMMARY_LINE" | grep -o "[0-9]* failed" | grep -o "[0-9]*" || echo "0")
            ERROR_COUNT=$(echo "$SUMMARY_LINE" | grep -o "[0-9]* error" | grep -o "[0-9]*" || echo "0")
            SKIPPED_COUNT=$(echo "$SUMMARY_LINE" | grep -o "[0-9]* skipped" | grep -o "[0-9]*" || echo "0")
            
            TOTAL_FAILED=$((FAILED_COUNT + ERROR_COUNT))
            TOTAL_COUNT=$((PASSED_COUNT + FAILED_COUNT + ERROR_COUNT + SKIPPED_COUNT))
            
            echo "### ⚠️ 測試未完全通過 Tests Not Fully Passed" >> test_report.md
            echo "" >> test_report.md
            echo "**📊 測試結果**: $PASSED_COUNT/$TOTAL_COUNT 通過" >> test_report.md
            
            if [ "$TOTAL_FAILED" -gt 0 ]; then
              echo "" >> test_report.md
              echo "**❌ 失敗的測試 ($TOTAL_FAILED 個):**" >> test_report.md
              echo "" >> test_report.md
              
              # 提取失敗測試名稱（簡化版）
              if grep "FAILED" test_output.txt | grep -o "tests/[^:]*::[^[:space:]]*" | sed 's/tests\///' | sed 's/::/ → /' > failed_tests.txt 2>/dev/null; then
                cat failed_tests.txt | while IFS= read -r test_name; do
                  echo "• \`$test_name\`" >> test_report.md
                done
              fi
            fi
            
            if [ "$SKIPPED_COUNT" -gt 0 ]; then
              echo "" >> test_report.md
              echo "**⏭️ 跳過**: $SKIPPED_COUNT 個測試" >> test_report.md
            fi
          fi
          
          echo "" >> test_report.md

      - name: 📊 Generate Coverage Report
        if: always()
        run: |
          # 生成簡潔的覆蓋率報告
          if [ -f coverage.xml ]; then
            COVERAGE_PERCENT=$(grep -o 'line-rate="[0-9.]*"' coverage.xml | head -1 | grep -o '[0-9.]*' | awk '{printf "%.1f", $1*100}')
            if [ ! -z "$COVERAGE_PERCENT" ]; then
              echo "**覆蓋率**: $COVERAGE_PERCENT%" >> test_report.md
              echo "" >> test_report.md
            fi
          fi

      - name: 🧪 Run Functional Tests
        id: functional-tests
        run: |
          if pytest tests/test_petsard.py --tb=line --quiet > functional_output.txt 2>&1; then
            echo "functional_status=success" >> $GITHUB_OUTPUT
            
            # 提取測試數量
            FUNC_TOTAL=$(grep -E "^[0-9]+ passed" functional_output.txt | grep -o "^[0-9]+" || echo "0")
            
            echo "### ✅ 功能測試通過 Functional Tests Passed" >> test_report.md
            echo "**📊 總計**: $FUNC_TOTAL 個功能測試全部通過" >> test_report.md
            echo "" >> test_report.md
          else
            echo "functional_status=failed" >> $GITHUB_OUTPUT
            
            # 提取測試統計
            SUMMARY_LINE=$(grep -E "^[0-9]+ (failed|passed)" functional_output.txt | tail -1)
            FUNC_PASSED=$(echo "$SUMMARY_LINE" | grep -o "[0-9]* passed" | grep -o "[0-9]*" || echo "0")
            FUNC_FAILED=$(echo "$SUMMARY_LINE" | grep -o "[0-9]* failed" | grep -o "[0-9]*" || echo "0")
            FUNC_TOTAL=$((FUNC_PASSED + FUNC_FAILED))
            
            echo "### ⚠️ 功能測試未完全通過 Functional Tests Not Fully Passed" >> test_report.md
            echo "**📊 功能測試**: $FUNC_PASSED/$FUNC_TOTAL 通過" >> test_report.md
            
            if [ "$FUNC_FAILED" -gt 0 ]; then
              echo "" >> test_report.md
              echo "**❌ 失敗的功能測試:**" >> test_report.md
              
              # 提取失敗測試名稱（簡化版）
              if grep "FAILED" functional_output.txt | grep -o "test_petsard.py::[^[:space:]]*" | sed 's/test_petsard.py:://' > failed_functional.txt 2>/dev/null; then
                cat failed_functional.txt | while IFS= read -r test_name; do
                  echo "• \`$test_name\`" >> test_report.md
                done
              fi
            fi
          fi
          
          echo "" >> test_report.md

      - name: 📊 Generate Test Summary
        run: |
          echo "---" >> test_report.md
          echo "" >> test_report.md
          echo "### 📊 總結 Summary" >> test_report.md
          echo "" >> test_report.md

          # 檢查所有步驟的狀態
          RUFF_STATUS="${{ steps.ruff-check.outputs.ruff_status }}"
          UNIT_STATUS="${{ steps.unit-tests.outputs.test_status }}"
          FUNC_STATUS="${{ steps.functional-tests.outputs.functional_status }}"

          if [[ "$RUFF_STATUS" == "success" && "$UNIT_STATUS" == "success" && "$FUNC_STATUS" == "success" ]]; then
            echo "## 🎉 所有檢查通過！All Checks Passed!" >> test_report.md
            echo "test_overall=success" >> $GITHUB_ENV
          else
            echo "## ⚠️ 檢查結果 Check Results" >> test_report.md
            echo "" >> test_report.md
            echo "| 檢查項目 | 狀態 |" >> test_report.md
            echo "|---------|------|" >> test_report.md
            echo "| 程式碼品質 Code Quality | $([ "$RUFF_STATUS" == "success" ] && echo "✅ 通過" || echo "❌ 失敗") |" >> test_report.md
            echo "| 單元測試 Unit Tests | $([ "$UNIT_STATUS" == "success" ] && echo "✅ 通過" || echo "❌ 失敗") |" >> test_report.md
            echo "| 功能測試 Functional Tests | $([ "$FUNC_STATUS" == "success" ] && echo "✅ 通過" || echo "❌ 失敗") |" >> test_report.md
            echo "test_overall=failed" >> $GITHUB_ENV
          fi

          echo "" >> test_report.md
          
          # 添加詳細輸出連結
          echo "<details>" >> test_report.md
          echo "<summary>📝 查看詳細測試輸出 View Detailed Output</summary>" >> test_report.md
          echo "" >> test_report.md
          echo "### 單元測試輸出 Unit Test Output" >> test_report.md
          echo "```" >> test_report.md
          cat test_output.txt | head -500 >> test_report.md
          echo "```" >> test_report.md
          echo "" >> test_report.md
          echo "### 功能測試輸出 Functional Test Output" >> test_report.md
          echo "```" >> test_report.md
          cat functional_output.txt | head -500 >> test_report.md
          echo "```" >> test_report.md
          echo "</details>" >> test_report.md
          
          echo "" >> test_report.md
          echo "---" >> test_report.md
          echo "*Python ${{ matrix.python-version }} | $(date -u +"%Y-%m-%d %H:%M UTC")*" >> test_report.md

      - name: 💬 Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');

            // 檢查是否已有測試結果留言
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              (comment.body.includes('🧪 測試結果 Test Results') || comment.body.includes('🧪 測試套件報告 Test Suite Report'))
            );

            const commentBody = `## 🧪 測試套件報告 Test Suite Report\n\n${report}`;

            if (botComment) {
              // 更新現有留言
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // 創建新留言
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: 📤 Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: |
            test_output.txt
            functional_output.txt
            test_report.md
            coverage.xml
            failures.txt
            summary.txt
            coverage_detail.txt
            coverage_table.txt
            ruff_output.txt
            ruff_report.md
            failed_tests.txt
            failed_functional.txt
            pytest-results.xml
          retention-days: 7

      - name: ℹ️ Test Status Summary
        if: always()
        run: |
          if [[ "$test_overall" == "success" ]]; then
            echo "::notice::🎉 所有檢查通過！All checks passed for Python ${{ matrix.python-version }} (Code Quality + Tests)"
          else
            echo "::warning::⚠️ 部分檢查失敗，但不會阻止合併。Some checks failed for Python ${{ matrix.python-version }} (Code Quality + Tests), but merge is not blocked."
          fi
