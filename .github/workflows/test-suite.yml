name: ğŸ§ª Test Suite

on:
  push:
    branches: [main, dev]
    paths:
      - "petsard/**"
      - "tests/**"
      - "pyproject.toml"
      - ".github/workflows/test-suite.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "petsard/**"
      - "tests/**"
      - "pyproject.toml"
      - ".github/workflows/test-suite.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: ğŸ§ª Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: ğŸ”§ Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ğŸ” Ruff Check
        id: ruff
        continue-on-error: true
        run: |
          ruff check . --output-format=json > ruff.json 2>&1 || true
          echo "status=$([ -s ruff.json ] && echo 'failed' || echo 'success')" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Run Tests
        id: pytest
        continue-on-error: true
        run: |
          pytest tests/ \
            --cov=petsard \
            --cov-report=term \
            --cov-report=xml \
            --cov-report=json \
            --tb=short \
            --junit-xml=junit.xml \
            -v 2>&1 | tee pytest.log || true
          
          # å„²å­˜é€€å‡ºç¢¼
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate Report
        if: always()
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import xml.etree.ElementTree as ET
          from pathlib import Path
          
          report = []
          report.append("## ğŸ§ª æ¸¬è©¦å ±å‘Š Test Report\n")
          
          # === Ruff çµæœ ===
          ruff_file = Path("ruff.json")
          if ruff_file.exists() and ruff_file.stat().st_size > 0:
              try:
                  with open("ruff.json") as f:
                      ruff_data = json.load(f)
                  
                  if ruff_data:
                      report.append(f"### âš ï¸ ç¨‹å¼ç¢¼å“è³ª ({len(ruff_data)} å€‹å•é¡Œ)\n")
                      
                      # æŒ‰æª”æ¡ˆåˆ†çµ„
                      by_file = {}
                      for issue in ruff_data[:20]:  # æœ€å¤šé¡¯ç¤º 20 å€‹
                          filename = issue.get('filename', 'unknown')
                          if filename not in by_file:
                              by_file[filename] = []
                          by_file[filename].append(issue)
                      
                      for filename, issues in by_file.items():
                          report.append(f"\n**{filename}**\n")
                          for issue in issues[:5]:  # æ¯æª”æ¡ˆæœ€å¤š 5 å€‹
                              line = issue.get('location', {}).get('row', '?')
                              code = issue.get('code', '?')
                              msg = issue.get('message', 'No message')
                              report.append(f"- Line {line}: `{code}` {msg}\n")
                      
                      if len(ruff_data) > 20:
                          report.append(f"\n*...é‚„æœ‰ {len(ruff_data) - 20} å€‹å•é¡Œ*\n")
                  else:
                      report.append("### âœ… ç¨‹å¼ç¢¼å“è³ªé€šé\n")
              except Exception as e:
                  report.append(f"### âš ï¸ ç„¡æ³•è§£æ Ruff çµæœ: {e}\n")
          else:
              report.append("### âœ… ç¨‹å¼ç¢¼å“è³ªé€šé\n")
          
          report.append("\n---\n\n")
          
          # === Pytest çµæœ ===
          junit_file = Path("junit.xml")
          coverage_file = Path("coverage.json")
          
          if junit_file.exists():
              try:
                  tree = ET.parse("junit.xml")
                  root = tree.getroot()
                  
                  total = int(root.get('tests', 0))
                  failures = int(root.get('failures', 0))
                  errors = int(root.get('errors', 0))
                  skipped = int(root.get('skipped', 0))
                  passed = total - failures - errors - skipped
                  
                  # æ¨™é¡Œ
                  if failures + errors == 0:
                      report.append(f"### âœ… æ¸¬è©¦é€šé ({passed}/{total})\n\n")
                  else:
                      report.append(f"### âŒ æ¸¬è©¦å¤±æ•— ({passed}/{total} é€šé)\n\n")
                  
                  # è¦†è“‹ç‡
                  if coverage_file.exists():
                      with open("coverage.json") as f:
                          cov_data = json.load(f)
                      coverage = cov_data.get('totals', {}).get('percent_covered', 0)
                      report.append(f"**è¦†è“‹ç‡**: {coverage:.1f}%\n\n")
                  
                  # å¤±æ•—çš„æ¸¬è©¦
                  if failures + errors > 0:
                      report.append(f"**å¤±æ•—çš„æ¸¬è©¦**:\n\n")
                      for testcase in root.iter('testcase'):
                          failure = testcase.find('failure')
                          error = testcase.find('error')
                          if failure is not None or error is not None:
                              classname = testcase.get('classname', '')
                              name = testcase.get('name', '')
                              report.append(f"- `{classname}::{name}`\n")
                              
                              # éŒ¯èª¤è¨Šæ¯
                              msg = (failure or error).get('message', '')
                              if msg:
                                  # åªå–ç¬¬ä¸€è¡Œ
                                  first_line = msg.split('\n')[0][:100]
                                  report.append(f"  *{first_line}*\n")
                      report.append("\n")
                  
                  # è·³éçš„æ¸¬è©¦
                  if skipped > 0:
                      report.append(f"**è·³é**: {skipped} å€‹æ¸¬è©¦\n\n")
                      
              except Exception as e:
                  report.append(f"### âš ï¸ ç„¡æ³•è§£ææ¸¬è©¦çµæœ: {e}\n\n")
          else:
              report.append("### âŒ æ‰¾ä¸åˆ°æ¸¬è©¦çµæœ\n\n")
          
          # === è©³ç´°è¼¸å‡º ===
          pytest_log = Path("pytest.log")
          if pytest_log.exists():
              report.append("\n<details>\n<summary>ğŸ“ è©³ç´°æ¸¬è©¦è¼¸å‡º</summary>\n\n```\n")
              with open("pytest.log") as f:
                  lines = f.readlines()
                  # åªé¡¯ç¤ºæœ€å¾Œ 200 è¡Œ
                  report.extend(lines[-200:])
              report.append("\n```\n</details>\n")
          
          # å¯«å…¥å ±å‘Š
          with open("test_report.md", "w") as f:
              f.writelines(report)
          
          print("".join(report))
          PYTHON_SCRIPT

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            
            // å°‹æ‰¾ç¾æœ‰ç•™è¨€
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('ğŸ§ª æ¸¬è©¦å ±å‘Š')
            );
            
            const body = `## ğŸ§ª æ¸¬è©¦å ±å‘Š (Python ${{ matrix.python-version }})\n\n${report}\n\n---\n*Updated at ${new Date().toISOString()}*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: ğŸ“¤ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            pytest.log
            junit.xml
            coverage.xml
            coverage.json
            ruff.json
            test_report.md
          retention-days: 7

      - name: â„¹ï¸ Summary
        if: always()
        run: |
          RUFF_STATUS="${{ steps.ruff.outputs.status }}"
          TEST_STATUS="${{ steps.pytest.outputs.status }}"
          
          if [[ "$RUFF_STATUS" == "success" && "$TEST_STATUS" == "0" ]]; then
            echo "::notice::âœ… Python ${{ matrix.python-version }}: æ‰€æœ‰æª¢æŸ¥é€šé"
          else
            echo "::warning::âš ï¸ Python ${{ matrix.python-version }}: éƒ¨åˆ†æª¢æŸ¥å¤±æ•—ï¼ˆä¸é˜»æ­¢åˆä½µï¼‰"
          fi
